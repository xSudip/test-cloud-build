name: Terraform

on:
  workflow_dispatch:
    inputs:
      Action:
        type: choice
        description: Choose the Terraform Action
        options: 
        - PLAN
        - APPLY
        - DESTROY
      Resource:
        type: choice
        description: Choose the Resource
        options:
        - test
        - cloud_functions
        - storage_bucket

jobs:
  terraform-plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${ { inputs.Resource } }
    steps:
        - name: Checkout
          if:  inputs.Action == 'PLAN'
          uses: actions/checkout@v3

        - name: Setup Terraform
          if:  inputs.Action == 'PLAN'
          uses: hashicorp/setup-terraform@v1
        
        - name: Terraform Plan
          if:  inputs.Action == 'PLAN'
          run: |
            terraform init
            terraform plan
          env:
            GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_KEY }}


  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        shell: bash
        working-directory: ${ { inputs.Resource } }
    steps:
        - name: Checkout
          if:  inputs.Action == 'APPLY'
          uses: actions/checkout@v3
        
        - name: Setup Terraform
          if:  inputs.Action == 'APPLY'
          uses: hashicorp/setup-terraform@v1
        
        - name: Terraform Apply
          if:  inputs.Action == 'APPLY'
          run: |
            terraform init
            terraform apply --auto-approve
          env:
            GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_KEY }}
